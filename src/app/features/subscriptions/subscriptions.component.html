<div class="subscriptions-container">
  <!-- Header -->
  <div class="subscriptions-header">
    <div class="header-top">
      <div>
        <h1 class="page-title">Gestione Abbonamenti</h1>
        <p class="page-subtitle">Crea e gestisci i piani di abbonamento della tua palestra</p>
      </div>
      <app-button (clicked)="openCreateMode()">
        <span>+</span> Nuovo Piano
      </app-button>
    </div>
  </div>

  <!-- Create/Edit Form -->
  @if (isCreating()) {
    <div class="form-card">
      <div class="form-header">
        <h2 class="form-title">Crea Nuovo Abbonamento</h2>
        <button class="close-btn" (click)="cancelCreate()">âœ•</button>
      </div>

      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="subscription-form">
        <div class="form-grid">
          <div class="form-field">
            <app-input
              label="NOME PIANO"
              formControlName="name"
              placeholder="es. Abbonamento Mensile"
              [error]="getError('name')"
            ></app-input>
          </div>

          <div class="form-row">
            <div class="form-field">
              <app-input
                label="PREZZO (â‚¬)"
                type="number"
                formControlName="price"
                placeholder="50"
                [error]="getError('price')"
              ></app-input>
            </div>

            <div class="form-field">
              <app-input
                label="DURATA (mesi)"
                type="number"
                formControlName="durationMonths"
                placeholder="1"
                [error]="getError('durationMonths')"
              ></app-input>
            </div>
          </div>

          <div class="form-field">
            <label class="field-label">DESCRIZIONE</label>
            <textarea
              formControlName="description"
              placeholder="Descrizione del piano (opzionale)"
              rows="3"
              class="textarea-field"
            ></textarea>
          </div>

          <div class="checkbox-group">
            <label class="checkbox-wrapper">
              <input type="checkbox" formControlName="isLimited" />
              <span class="checkbox-label">Limita gli ingressi mensili</span>
            </label>
            
            @if (form.get('isLimited')?.value) {
              <div class="form-field" style="margin-top: 1rem;">
                <app-input
                  label="INGRESSI MASSIMI"
                  type="number"
                  formControlName="maxEntries"
                  placeholder="10"
                ></app-input>
              </div>
            }
          </div>
        </div>

        <div class="form-actions">
          <app-button variant="secondary" type="button" (clicked)="cancelCreate()">
            Annulla
          </app-button>
          <app-button type="submit" [loading]="loading" [disabled]="form.invalid">
            Crea Abbonamento
          </app-button>
        </div>
      </form>
    </div>
  }

  <!-- Subscriptions Grid -->
  <div class="subscriptions-content">
    @if (subscriptions().length > 0) {
      <div class="subscriptions-grid">
        @for (sub of subscriptions(); track sub.id) {
          <div class="subscription-card">
            <div class="card-header">
              <div class="plan-badge">
                <span class="badge-icon">ğŸ’</span>
              </div>
              <button class="delete-btn" (click)="deleteSub(sub.id)">
                <span>ğŸ—‘ï¸</span>
              </button>
            </div>

            <div class="card-body">
              <h3 class="plan-name">{{ sub.name }}</h3>
              
              <div class="price-section">
                <span class="price-amount">{{ sub.price | currency:'EUR' }}</span>
                <span class="price-period">/ {{ sub.durationMonths }} {{ sub.durationMonths === 1 ? 'mese' : 'mesi' }}</span>
              </div>

              @if (sub.description) {
                <p class="plan-description">{{ sub.description }}</p>
              }

              <div class="plan-features">
                <div class="feature-item">
                  <span class="feature-icon">ğŸ“…</span>
                  <span class="feature-text">ValiditÃ : {{ sub.durationMonths }} {{ sub.durationMonths === 1 ? 'mese' : 'mesi' }}</span>
                </div>
                @if (sub.maxEntries) {
                  <div class="feature-item">
                    <span class="feature-icon">ğŸ«</span>
                    <span class="feature-text">Max {{ sub.maxEntries }} ingressi/mese</span>
                  </div>
                } @else {
                  <div class="feature-item unlimited">
                    <span class="feature-icon">â™¾ï¸</span>
                    <span class="feature-text">Ingressi illimitati</span>
                  </div>
                }
              </div>
            </div>

            <div class="card-footer">
              <div class="stats-row">
                <div class="stat-item">
                  <span class="stat-value">{{ getActiveMembers(sub.id) }}</span>
                  <span class="stat-label">Iscritti attivi</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">â‚¬ {{ getMonthlyRevenue(sub.id) }}</span>
                  <span class="stat-label">Entrate/mese</span>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    } @else {
      <div class="empty-state">
        <div class="empty-icon">ğŸ’³</div>
        <h3 class="empty-title">Nessun piano abbonamento</h3>
        <p class="empty-message">
          Inizia creando il tuo primo piano di abbonamento per gli iscritti della palestra.
        </p>
        <app-button (clicked)="openCreateMode()">
          Crea primo piano
        </app-button>
      </div>
    }
  </div>
</div>
