<div class="schedule-container">
  <!-- Header -->
  <div class="schedule-header">
    <div class="header-content">
      <div>
        <h1 class="page-title">Calendario Lezioni</h1>
        <p class="page-subtitle">Organizza e visualizza il palinsesto settimanale</p>
      </div>
      <button class="add-lesson-btn" (click)="openAddModal()">
        <span class="btn-icon">‚ûï</span>
        <span class="btn-text">Nuova Lezione</span>
      </button>
    </div>
  </div>

  <!-- Calendar Controls -->
  <div class="calendar-controls">
    <div class="date-selectors">
      <select [(ngModel)]="selectedMonth" (ngModelChange)="onMonthYearChange()" class="month-select">
        @for (month of monthNames; track $index) {
        <option [value]="$index">{{ month }}</option>
        }
      </select>

      <select [(ngModel)]="selectedYear" (ngModelChange)="onMonthYearChange()" class="year-select">
        @for (year of years; track year) {
        <option [value]="year">{{ year }}</option>
        }
      </select>
    </div>

    <div class="week-navigation">
      <button class="nav-btn" (click)="prevWeek()">
        <span>‚Üê</span>
      </button>
      <button class="today-btn" (click)="goToToday()">
        Oggi
      </button>
      <button class="nav-btn" (click)="nextWeek()">
        <span>‚Üí</span>
      </button>
    </div>
  </div>

  <!-- Week Days Grid -->
  <div class="week-grid">
    @for (day of weekDays(); track day.date.getTime()) {
    <div class="day-card" [class.today]="day.isToday"
      [class.selected]="selectedDate()?.date?.getTime() === day.date.getTime()" (click)="selectDate(day)">
      <div class="day-header">
        <span class="day-name">{{ day.dayName }}</span>
        <span class="day-number">{{ day.dayNumber }}</span>
      </div>
      @if (day.isToday) {
      <div class="today-indicator">Oggi</div>
      }
    </div>
    }
  </div>

  <!-- Daily Schedule -->
  @if (selectedDate(); as selected) {
  <div class="daily-schedule">
    <div class="schedule-title-bar">
      <h2 class="schedule-title">
        <span class="title-icon">üìÖ</span>
        {{ dayLabels[selected.fullDay] }} {{ selected.dayNumber }} {{ monthNames[selected.date.getMonth()] }}
      </h2>
      <span class="schedule-subtitle">Palinsesto odierno</span>
    </div>

    <div class="lessons-container">
      @for (slot of dailySlots(); track slot.courseId + slot.timeStart) {
      <div class="lesson-slot" [class]="slot.colorClass" (click)="onSlotClick(slot)">
        <div class="slot-time">
          <span class="time-start">{{ slot.timeStart }}</span>
          <span class="time-separator">-</span>
          <span class="time-end">{{ slot.timeEnd }}</span>
        </div>

        <div class="slot-content">
          <h3 class="slot-name">{{ slot.name }}</h3>
          <div class="slot-instructor">
            <span class="instructor-icon">üë§</span>
            <span>{{ slot.instructor }}</span>
          </div>
        </div>

        <div class="slot-meta">
          <div class="members-count">
            <span class="count-icon">üë•</span>
            <span class="count-value">{{ slot.membersCount }}</span>
          </div>
          <div class="slot-arrow">‚Üí</div>
        </div>
      </div>
      } @empty {
      <div class="empty-day">
        <div class="empty-icon">üì≠</div>
        <p class="empty-message">Nessun corso in programma per questo giorno</p>
        <button class="empty-action-btn" (click)="openAddModal()">
          Aggiungi Lezione
        </button>
      </div>
      }
    </div>
  </div>
  }
</div>

<!-- Lesson Detail Modal -->
<dialog id="lesson-detail-dialog" class="modal-dialog detail-modal">
  @if (selectedDetailSlot(); as slot) {
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Dettagli Lezione</h2>
      <button class="modal-close" (click)="closeDetailModal()">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="detail-card">
        <div class="detail-badge" [class]="slot.colorClass">
          <span class="badge-time">üìÖ {{ dayLabels[slot.day] }} {{ slot.timeStart }} - {{ slot.timeEnd }}</span>
        </div>

        <h3 class="detail-name clickable" (click)="navigateToCourse(slot.courseId)" title="Vai alla pagina del corso">
          {{ slot.name }}
        </h3>

        <div class="detail-info-grid">
          <div class="info-item clickable" (click)="navigateToInstructors()" title="Vai alla pagina dei maestri">
            <span class="info-label">Istruttore</span>
            <span class="info-value">üë§ {{ slot.instructor }}</span>
          </div>
        </div>

        <div class="members-section">
          <h4 class="members-title">Iscritti alla lezione ({{ slot.membersCount }})</h4>
          <div class="members-list-scroll">
            @for (member of slot.members; track member.id) {
            <div class="member-chip" (click)="navigateToMember(member.id)" style="cursor: pointer;">
              <span class="member-avatar-mini">{{ member.firstName.charAt(0) }}</span>
              <span class="member-name-mini">{{ member.firstName }} {{ member.lastName }}</span>
            </div>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="modal-action-btn book-btn" (click)="confirmBooking()" [disabled]="bookingLoading()">
        @if (bookingLoading()) {
        <span>‚è≥ Prenotazione...</span>
        } @else {
        <span>‚úì Prenota Lezione</span>
        }
      </button>
      <button class="modal-action-btn edit-btn" (click)="editLesson()">
        ‚úèÔ∏è Modifica
      </button>
      <button class="modal-action-btn delete-btn" (click)="deleteLesson()">
        üóëÔ∏è Elimina
      </button>
    </div>
  </div>
  }
</dialog>

<!-- Add/Edit Lesson Modal -->
<dialog id="add-lesson-dialog" class="modal-dialog form-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">
        {{ isEditing() ? 'Modifica Lezione' : 'Nuova Lezione' }}
      </h2>
      <button class="modal-close" (click)="closeAddModal()">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="form-grid">
        <div class="form-field">
          <label class="field-label">NOME CORSO</label>
          <input type="text" class="field-input" placeholder="es. Boxe Principianti" [ngModel]="courseForm().name"
            (ngModelChange)="courseForm.set({...courseForm(), name: $event})" />
        </div>

        <div class="form-field">
          <label class="field-label">ISTRUTTORE</label>
          <input type="text" class="field-input" placeholder="es. Marco Rossi" [ngModel]="courseForm().instructor"
            (ngModelChange)="courseForm.set({...courseForm(), instructor: $event})" />
        </div>

        <div class="form-field">
          <label class="field-label">SPORT</label>
          <select class="field-select" [ngModel]="courseForm().sport"
            (ngModelChange)="courseForm.set({...courseForm(), sport: $event})">
            @for (sport of sports; track sport) {
            <option [value]="sport">{{ sport.toUpperCase() }}</option>
            }
          </select>
        </div>

        <div class="form-field">
          <label class="field-label">GIORNO</label>
          <select class="field-select" [ngModel]="courseForm().day"
            (ngModelChange)="courseForm.set({...courseForm(), day: $event})">
            <option value="monday">Luned√¨</option>
            <option value="tuesday">Marted√¨</option>
            <option value="wednesday">Mercoled√¨</option>
            <option value="thursday">Gioved√¨</option>
            <option value="friday">Venerd√¨</option>
            <option value="saturday">Sabato</option>
            <option value="sunday">Domenica</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label class="field-label">ORA INIZIO</label>
            <input type="time" class="field-input" [ngModel]="courseForm().startTime"
              (ngModelChange)="courseForm.set({...courseForm(), startTime: $event})" />
          </div>

          <div class="form-field">
            <label class="field-label">ORA FINE</label>
            <input type="time" class="field-input" [ngModel]="courseForm().endTime"
              (ngModelChange)="courseForm.set({...courseForm(), endTime: $event})" />
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="modal-action-btn secondary-btn" (click)="closeAddModal()">
        Annulla
      </button>
      <button class="modal-action-btn save-btn" (click)="saveCourse()">
        {{ isEditing() ? 'Salva Modifiche' : 'Crea Lezione' }}
      </button>
    </div>
  </div>
</dialog>