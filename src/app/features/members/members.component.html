<div class="members-container">
    <!-- Header -->
    <div class="members-header">
        <div class="header-top">
            <div>
                <h1 class="page-title">Gestione Iscritti</h1>
                <p class="page-subtitle">Amministra i membri della tua palestra</p>
            </div>
            <app-button (clicked)="openAddModal()">
                <span>+</span> Nuovo Iscritto
            </app-button>
        </div>

        <!-- Search & Filters -->
        <div class="filters-section">
            <div class="search-wrapper">
                <app-input type="search" placeholder="Cerca per nome, cognome o email..." [(ngModel)]="searchQuery"
                    (ngModelChange)="filterMembers()"></app-input>
            </div>

            <div class="filter-tabs">
                <button class="filter-tab" [class.active]="filterStatus === 'all'" (click)="setFilter('all')">
                    <span class="tab-label">Tutti</span>
                    <span class="tab-count">{{ totalCount }}</span>
                </button>
                <button class="filter-tab" [class.active]="filterStatus === 'active'" (click)="setFilter('active')">
                    <span class="tab-label">Attivi</span>
                    <span class="tab-count">{{ activeCount }}</span>
                </button>
                <button class="filter-tab" [class.active]="filterStatus === 'expiring'" (click)="setFilter('expiring')">
                    <span class="tab-label">In Scadenza</span>
                    <span class="tab-count">{{ expiringCount }}</span>
                </button>
                <button class="filter-tab" [class.active]="filterStatus === 'expired'" (click)="setFilter('expired')">
                    <span class="tab-label">Scaduti</span>
                    <span class="tab-count">{{ expiredCount }}</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Members Grid -->
    <div class="members-content">
        @if (filteredMembers().length > 0) {
        <div class="members-grid">
            @for (member of filteredMembers(); track member.id) {
            <div class="member-card" (click)="goToDetail(member)">
                <div class="member-card-header">
                    <div class="member-avatar">
                        {{ getInitials(member) }}
                    </div>
                    <div class="member-status">
                        @switch (getSubscriptionStatus(member)) {
                        @case ('active') {
                        <span class="status-badge active">Attivo</span>
                        }
                        @case ('expiring') {
                        <span class="status-badge expiring"
                            style="background-color: rgba(255, 193, 7, 0.15); color: #FFC107; border: 1px solid rgba(255, 193, 7, 0.3);">In
                            Scadenza</span>
                        }
                        @case ('expired') {
                        <span class="status-badge expired"
                            style="background-color: rgba(239, 83, 80, 0.15); color: #EF5350; border: 1px solid rgba(239, 83, 80, 0.3);">Scaduto</span>
                        }
                        @case ('inactive') {
                        <span class="status-badge inactive">Inattivo</span>
                        }
                        }
                    </div>
                </div>

                <div class="member-card-body">
                    <h3 class="member-name">{{ member.firstName }} {{ member.lastName }}</h3>
                    <p class="member-email">{{ member.email }}</p>

                    <div class="member-meta">
                        <div class="meta-item">
                            <span class="meta-icon">ðŸ“…</span>
                            <span class="meta-text">Iscritto {{ member.joinedAt | date:'dd/MM/yyyy' }}</span>
                        </div>
                        @if (member.phone) {
                        <div class="meta-item">
                            <span class="meta-icon">ðŸ“ž</span>
                            <span class="meta-text">{{ member.phone }}</span>
                        </div>
                        }
                    </div>
                </div>

                <div class="member-card-footer">
                    <span class="view-details">
                        Vedi dettagli â†’
                    </span>
                </div>
            </div>
            }
        </div>
        } @else {
        <div class="empty-state">
            <div class="empty-icon">ðŸ‘¥</div>
            <h3 class="empty-title">Nessun iscritto trovato</h3>
            <p class="empty-message">
                @if (searchQuery) {
                Nessun risultato per "{{ searchQuery }}"
                } @else {
                Non ci sono ancora iscritti. Inizia aggiungendone uno!
                }
            </p>
            @if (!searchQuery) {
            <app-button (clicked)="openAddModal()">
                Aggiungi primo iscritto
            </app-button>
            }
        </div>
        }
    </div>

    <!-- Modal Nuovo Iscritto -->
    <app-modal [isOpen]="isModalOpen()" title="Nuovo Iscritto" confirmLabel="Aggiungi" [loading]="isSubmitting()"
        (close)="closeModal()" (confirm)="onAddMember()">

        <form [formGroup]="memberForm" class="member-form">
            <div class="form-row">
                <div class="form-group flex-1">
                    <label>Nome</label>
                    <app-input placeholder="Es. Marco" formControlName="firstName"
                        [error]="memberForm.get('firstName')?.touched && memberForm.get('firstName')?.invalid ? 'Il nome Ã¨ obbligatorio' : undefined"></app-input>
                </div>
                <div class="form-group flex-1">
                    <label>Cognome</label>
                    <app-input placeholder="Es. Rossi" formControlName="lastName"
                        [error]="memberForm.get('lastName')?.touched && memberForm.get('lastName')?.invalid ? 'Il cognome Ã¨ obbligatorio' : undefined"></app-input>
                </div>
            </div>

            <div class="form-group">
                <label>Email</label>
                <app-input type="email" placeholder="email@esempio.com" formControlName="email"
                    [error]="memberForm.get('email')?.touched && memberForm.get('email')?.invalid ? 'Inserisci un\'email valida' : undefined"></app-input>
            </div>

            <div class="form-group">
                <label>Telefono</label>
                <app-input placeholder="333 1234567" formControlName="phone"></app-input>
            </div>
        </form>
    </app-modal>
</div>