<div class="member-detail-container">
  @if (member(); as m) {
  <!-- Header con Avatar e Info Base -->
  <div class="member-header">
    <button class="back-btn" [routerLink]="sourcePage() === 'schedule' ? '/app/schedule' : '/app/members'">
      â† {{ sourcePage() === 'schedule' ? 'Torna al Calendario' : 'Torna agli Iscritti' }}
    </button>

    <div class="header-card">
      <div class="avatar-section">
        <div class="member-avatar">{{ getInitials(m) }}</div>
        <button class="edit-avatar-btn" (click)="notImplementedYet('Modifica avatar')">ğŸ“·</button>
      </div>

      <div class="header-info">
        <h1 class="member-name">{{ m.firstName }} {{ m.lastName }}</h1>

        <div class="member-meta">
          <span class="meta-item">
            <span class="meta-icon">{{ athleteData.gender === 'M' ? 'â™‚ï¸' : 'â™€ï¸' }}</span>
            <span class="meta-text">{{ athleteData.gender === 'M' ? 'Maschio' : 'Femmina' }}</span>
          </span>
          <span class="meta-item">
            <span class="meta-icon">ğŸ‚</span>
            <span class="meta-text">{{ getAge(athleteData.birthDate) }} anni</span>
          </span>
          <span class="meta-item">
            <span class="meta-icon">ğŸ“…</span>
            <span class="meta-text">Iscritto il {{ m.joinedAt | date:'dd/MM/yyyy' }}</span>
          </span>
        </div>


      </div>

      <div class="header-actions">
        <div class="actions-row">
          <button class="action-btn secondary-btn" (click)="openEditProfile()">
            <span class="btn-icon">âœï¸</span>
            <span>Modifica Profilo</span>
          </button>
          <button class="action-btn secondary-btn" (click)="notImplementedYet('Invio messaggi')">
            <span class="btn-icon">ğŸ’¬</span>
            <span>Messaggio</span>
          </button>
        </div>
        @if (getVisibleSubscription(); as sub) {
        <button class="action-btn primary-btn" (click)="openRenewPanel()">
          <span class="btn-icon">ğŸ”„</span>
          <span>Rinnova</span>
        </button>
        } @else {
        <button class="action-btn primary-btn" (click)="openRenewPanel()">
          <span class="btn-icon">â•</span>
          <span>Assegna Piano</span>
        </button>
        }
      </div>

    </div>
  </div>

  <!-- Subscription Renewal / Assignment Panel -->
  @if (isRenewing()) {
  <div class="renew-panel">
    <div class="renew-header">
      <h2 class="renew-title">{{ getVisibleSubscription() ? 'ğŸ”„ Rinnova Abbonamento' : 'â• Assegna Piano' }}</h2>
      <button class="close-btn" (click)="cancelRenew()">âœ•</button>
    </div>

    <p class="renew-subtitle">Seleziona il piano di abbonamento da assegnare a questo iscritto</p>

    @if (availableSubscriptions().length > 0) {
    <div class="plans-grid">
      @for (sub of availableSubscriptions(); track sub.id) {
      <div class="plan-option" [class.current]="getVisibleSubscription()?.id === sub.id">
        @if (getVisibleSubscription()?.id === sub.id) {
        <div class="current-badge">Piano Attuale</div>
        }
        <div class="plan-option-header">
          <span class="plan-icon">ğŸ’</span>
          <h3 class="plan-option-name">{{ sub.name }}</h3>
        </div>
        <div class="plan-option-price">
          <span class="plan-price-amount">{{ sub.price | currency:'EUR' }}</span>
          <span class="plan-price-period">/ {{ sub.durationMonths }} {{ sub.durationMonths === 1 ? 'mese' : 'mesi'
            }}</span>
        </div>
        @if (sub.description) {
        <p class="plan-option-desc">{{ sub.description }}</p>
        }
        <div class="plan-option-features">
          <span class="plan-feature">ğŸ“… {{ sub.durationMonths }} {{ sub.durationMonths === 1 ? 'mese' : 'mesi' }}</span>
          @if (sub.maxEntries) {
          <span class="plan-feature">ğŸ« Max {{ sub.maxEntries }} ingressi/mese</span>
          } @else {
          <span class="plan-feature unlimited">â™¾ï¸ Ingressi illimitati</span>
          }
        </div>
        <button class="plan-select-btn" [class.current-plan]="getVisibleSubscription()?.id === sub.id"
          [disabled]="renewLoading" (click)="assignPlan(sub)">
          @if (getVisibleSubscription()?.id === sub.id) {
          ğŸ”„ Rinnova questo piano
          } @else {
          âœ“ Seleziona questo piano
          }
        </button>
      </div>
      }
    </div>
    } @else {
    <div class="empty-plans">
      <div class="empty-plans-icon">ğŸ’³</div>
      <p class="empty-plans-text">Nessun piano abbonamento disponibile.<br>Crea un piano nella sezione Abbonamenti.</p>
    </div>
    }
  </div>
  }

  <!-- Edit Profile Panel -->
  @if (isEditingProfile()) {
  <div class="renew-panel">
    <div class="renew-header">
      <h2 class="renew-title">âœï¸ Modifica Profilo</h2>
      <button class="close-btn" (click)="cancelEditProfile()">âœ•</button>
    </div>

    <p class="renew-subtitle">Modifica i dati personali dell'iscritto</p>

    <form [formGroup]="profileForm" (ngSubmit)="onProfileSubmit()" class="profile-form">
      <div class="profile-form-grid">
        <div class="profile-form-row">
          <div class="profile-form-field">
            <app-input label="NOME" formControlName="firstName" placeholder="es. Marco"></app-input>
          </div>
          <div class="profile-form-field">
            <app-input label="COGNOME" formControlName="lastName" placeholder="es. Rossi"></app-input>
          </div>
        </div>

        <div class="profile-form-row">
          <div class="profile-form-field">
            <app-input label="EMAIL" type="email" formControlName="email"
              placeholder="es. marco&#64;email.com"></app-input>
          </div>
          <div class="profile-form-field">
            <app-input label="TELEFONO" formControlName="phone" placeholder="es. 320 1234567"></app-input>
          </div>
        </div>

        <div class="profile-form-row">
          <div class="profile-form-field">
            <label class="profile-field-label">SESSO</label>
            <select formControlName="gender" class="profile-select-field">
              <option value="M">â™‚ï¸ Maschio</option>
              <option value="F">â™€ï¸ Femmina</option>
            </select>
          </div>
          <div class="profile-form-field">
            <label class="profile-field-label">DATA DI NASCITA</label>
            <input type="date" formControlName="birthDate" class="profile-date-field" />
          </div>
        </div>

        <div class="profile-form-row">
          <div class="profile-form-field">
            <app-input label="PESO (kg)" type="number" formControlName="weight" placeholder="75"></app-input>
          </div>
          <div class="profile-form-field">
            <app-input label="ALTEZZA (cm)" type="number" formControlName="height" placeholder="180"></app-input>
          </div>
        </div>
      </div>

      <div class="profile-form-actions">
        <button type="button" class="profile-cancel-btn" (click)="cancelEditProfile()">
          Annulla
        </button>
        <button type="submit" class="profile-save-btn" [disabled]="profileForm.invalid || editProfileLoading">
          @if (editProfileLoading) {
          Salvataggio...
          } @else {
          ğŸ’¾ Salva Modifiche
          }
        </button>
      </div>
    </form>
  </div>
  }

  <!-- Discipline Add/Edit Panel -->
  @if (isAddingDiscipline() || isEditingDiscipline()) {
  <div class="renew-panel">
    <div class="renew-header">
      <h2 class="renew-title">{{ isEditingDiscipline() ? 'âœï¸ Modifica Disciplina' : 'â• Nuova Disciplina' }}</h2>
      <button class="close-btn" (click)="cancelDisciplineForm()" title="Chiudi">âœ•</button>
    </div>

    <p class="renew-subtitle">Gestisci i dettagli della disciplina e il record sportivo</p>

    <form [formGroup]="disciplineForm" (ngSubmit)="saveDiscipline()" class="discipline-form">
      <div class="disc-form-grid">
        <div class="disc-form-row">
          <div class="disc-form-field">
            <label class="profile-field-label">DISCIPLINA</label>
            <select formControlName="discipline" class="profile-select-field">
              <option value="MMA">ğŸ¥‹ MMA</option>
              <option value="Kickboxing">ğŸ¦µ Kickboxing</option>
              <option value="Boxe">ğŸ¥Š Boxe</option>
              <option value="Muay Thai">âš¡ Muay Thai</option>
            </select>
          </div>
          <div class="disc-form-field">
            <label class="profile-field-label">LIVELLO</label>
            <select formControlName="level" class="profile-select-field">
              <option value="Principiante">Amatore</option>
              <option value="Intermedio">Agonista light contact</option>
              <option value="ClasseN">Agonista full contact classe N</option>
              <option value="ClasseC">Agonista full contact classe C</option>
              <option value="ClasseB">Agonista full contact classe B</option>
              <option value="ClasseA">Agonista full contact classe A</option>
              <option value="Pro">Pro</option>
            </select>
          </div>
        </div>

        <div class="disc-form-section-label">RECORD (W - L - D)</div>
        <div class="disc-form-row disc-form-row-3">
          <div class="disc-form-field">
            <app-input label="VITTORIE" type="number" formControlName="wins" placeholder="0"></app-input>
          </div>
          <div class="disc-form-field">
            <app-input label="SCONFITTE" type="number" formControlName="losses" placeholder="0"></app-input>
          </div>
          <div class="disc-form-field">
            <app-input label="PAREGGI" type="number" formControlName="draws" placeholder="0"></app-input>
          </div>
        </div>
      </div>

      <div class="profile-form-actions">
        <button type="button" class="profile-cancel-btn" (click)="cancelDisciplineForm()">
          Annulla
        </button>
        <button type="submit" class="profile-save-btn" [disabled]="disciplineForm.invalid">
          {{ isEditingDiscipline() ? 'ğŸ’¾ Salva Modifiche' : 'â• Aggiungi' }}
        </button>
      </div>
    </form>
  </div>
  }

  <!-- Grid 2x2: Abbonamento | Record | Documenti | Contatti -->
  <div class="cards-grid">
    <!-- Card 1: Abbonamento -->
    <div class="grid-card subscription-card">
      <div class="card-header">
        <h2 class="card-title">ğŸ’³ Abbonamento</h2>
      </div>
      @if (getVisibleSubscription(); as sub) {
      <div class="subscription-content">
        <div class="sub-details">
          <div class="sub-detail-row">
            <span class="detail-icon">ğŸ“‹</span>
            <div class="detail-content">
              <span class="detail-label">Piano</span>
              <span class="detail-value highlight">{{ sub.name }}</span>
            </div>
          </div>

          <div class="sub-detail-row">
            <span class="detail-icon">ğŸ’°</span>
            <div class="detail-content">
              <span class="detail-label">Costo</span>
              <span class="detail-value">{{ sub.price | currency:'EUR' }}</span>
            </div>
          </div>

          <div class="sub-detail-row">
            <span class="detail-icon">â±ï¸</span>
            <div class="detail-content">
              <span class="detail-label">Durata</span>
              <span class="detail-value">{{ sub.durationMonths }} mesi</span>
            </div>
          </div>

          <div class="sub-detail-row highlight-row" [class]="getSubscriptionStatus(m)">
            <span class="detail-icon">ğŸ“…</span>
            <div class="detail-content">
              <span class="detail-label">Scadenza</span>
              <div class="expiry-container">
                <span class="status-text-inline">
                  @switch (getSubscriptionStatus(m)) {
                  @case ('active') { ATTIVO }
                  @case ('expiring') { IN SCADENZA }
                  @case ('expired') { SCADUTO }
                  }
                </span>
                <span class="detail-value expiry">{{ getExpiryDate(m) | date:'dd MMM yyyy' }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="sub-disciplines-section">
        <h3 class="sub-disciplines-title">Discipline Attive</h3>
        <div class="member-disciplines">
          @for (disc of disciplines(); track disc.id) {
          <span class="discipline-badge clickable" (click)="navigateToCourses(disc.discipline)"
            title="Vedi corsi di {{ disc.discipline }}">
            <span class="badge-icon">{{ getDisciplineIcon(disc.discipline) }}</span>
            <span class="badge-text">{{ disc.discipline }}</span>
          </span>
          }
        </div>
      </div>
      } @else {
      <div class="empty-state">
        <div class="sub-status-badge inactive">
          <span class="status-icon">âœ•</span>
          <span class="status-text">INATTIVO</span>
        </div>
        <div class="empty-icon">ğŸ’³</div>
        <p class="empty-text">Nessun abbonamento attivo</p>
        <button class="card-action-btn primary" (click)="openRenewPanel()">â• Assegna Piano</button>
      </div>
      }
    </div>

    <!-- Card 2: Record Combattimenti -->
    <div class="grid-card record-card">
      <div class="card-header">
        <h2 class="card-title">ğŸ¥Š Record Combattimenti</h2>
        <div class="header-controls">
          @if (disciplines().length > 1) {
          <div class="discipline-selector">
            <button class="discipline-selector-btn" (click)="toggleDisciplineDropdown()"
              [class.active]="isDisciplineDropdownOpen()">
              <span class="selected-discipline">
                <span class="discipline-icon">{{ getDisciplineIcon(selectedDiscipline()?.discipline || '') }}</span>
                <span class="discipline-name">{{ selectedDiscipline()?.discipline }}</span>
              </span>
              <span class="dropdown-arrow" [class.rotate]="isDisciplineDropdownOpen()">â–¼</span>
            </button>

            @if (isDisciplineDropdownOpen()) {
            <div class="discipline-dropdown">
              @for (disc of disciplines(); track disc.id) {
              <button class="discipline-option" [class.selected]="selectedDiscipline()?.id === disc.id"
                (click)="selectDiscipline(disc)">
                <span class="option-icon">{{ getDisciplineIcon(disc.discipline) }}</span>
                <span class="option-name">{{ disc.discipline }}</span>
                @if (selectedDiscipline()?.id === disc.id) {
                <span class="check-icon">âœ“</span>
                }
              </button>
              }
            </div>
            }
          </div>
          } @else if (disciplines().length === 1) {
          <div class="single-discipline-badge">
            <span class="discipline-icon">{{ getDisciplineIcon(disciplines()[0].discipline) }}</span>
            <span class="discipline-name">{{ disciplines()[0].discipline }}</span>
          </div>
          }
          <button class="header-btn" title="Aggiungi Disciplina" (click)="openAddDiscipline()">â•</button>
        </div>

      </div>

      @if (selectedDiscipline(); as discipline) {
      <div class="record-content">
        <!-- Record W-L-D -->
        <div class="record-display">
          <div class="record-label">
            {{ discipline.discipline }} - Record Totale
          </div>
          <div class="record-numbers">
            <div class="record-number wins">
              <div class="number-value">{{ discipline.record.wins }}</div>
              <div class="number-label">W</div>
            </div>
            <span class="record-separator">-</span>
            <div class="record-number losses">
              <div class="number-value">{{ discipline.record.losses }}</div>
              <div class="number-label">L</div>
            </div>
            <span class="record-separator">-</span>
            <div class="record-number draws">
              <div class="number-value">{{ discipline.record.draws }}</div>
              <div class="number-label">D</div>
            </div>
          </div>
        </div>

        <!-- Dati Atletici per Disciplina -->
        <div class="athlete-data">
          <div class="athlete-data-row">
            <span class="data-icon">âš–ï¸</span>
            <div class="data-content">
              <span class="data-label">Peso</span>
              <span class="data-value">{{ athleteData.weight }} kg</span>
            </div>
          </div>

          <div class="athlete-data-row">
            <span class="data-icon">ğŸ“</span>
            <div class="data-content">
              <span class="data-label">Altezza</span>
              <span class="data-value">{{ athleteData.height }} cm</span>
            </div>
          </div>

          <div class="athlete-data-row">
            <span class="data-icon">ğŸ“Š</span>
            <div class="data-content">
              <span class="data-label">Livello</span>
              <span class="data-value">
                <span class="level-badge">{{ discipline.level }}</span>
              </span>
            </div>
          </div>

          <div class="athlete-data-row stats-row">
            <span class="data-icon">ğŸ“ˆ</span>
            <div class="data-content">
              <span class="data-label">Statistiche</span>
              <div class="stats-inline">
                <span class="stat-item">
                  <span class="stat-label">Win Rate:</span>
                  <span class="stat-value success">{{ getWinRateByDiscipline(discipline.record) }}%</span>
                </span>
                <span class="stat-item">
                  <span class="stat-label">Match:</span>
                  <span class="stat-value">{{ getTotalFightsByDiscipline(discipline.record) }}</span>
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="discipline-actions">
          <button class="card-action-btn secondary" (click)="openEditDiscipline(discipline)">âœï¸ Modifica {{
            discipline.discipline }}</button>
          <button class="card-action-btn-delete" (click)="deleteDiscipline(discipline)">ğŸ—‘ï¸ Elimina</button>
        </div>
      </div>
      } @else {
      <div class="empty-state">
        <div class="empty-icon">ğŸ¥Š</div>
        <p class="empty-text">Nessuna disciplina registrata</p>
        <button class="card-action-btn primary" (click)="openAddDiscipline()">â• Aggiungi Disciplina</button>
      </div>
      }
    </div>


    <!-- Card 3: Documenti -->
    <div class="grid-card documents-card">
      <div class="card-header">
        <h2 class="card-title">ğŸ“ Documenti</h2>
        <button class="header-btn" (click)="uploadDocument()" title="Carica">â•</button>
      </div>

      <div class="documents-content">
        <div class="documents-list">
          @for (doc of documents(); track doc.id) {
          <div class="document-item" [class]="getStatusColor(doc.status)">
            <div class="doc-icon">{{ getDocumentIcon(doc.type) }}</div>
            <div class="doc-info">
              <div class="doc-name">{{ doc.name }}</div>
              <div class="doc-status" [class]="getStatusColor(doc.status)">
                @if (doc.status === 'valid') {
                <span>âœ“ Valido</span>
                } @else if (doc.status === 'expiring') {
                <span>âš ï¸ In scadenza</span>
                } @else {
                <span>âœ• Scaduto</span>
                }
              </div>
            </div>
            <div class="doc-actions">
              <button class="doc-action-btn" (click)="downloadDocument(doc)" title="Scarica">â¬‡ï¸</button>
              <button class="doc-action-btn delete" (click)="deleteDocument(doc)" title="Elimina">ğŸ—‘ï¸</button>
            </div>
          </div>
          } @empty {
          <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <p class="empty-text">Nessun documento caricato</p>
            <button class="card-action-btn secondary" (click)="uploadDocument()">
              ğŸ“¤ Carica Documento
            </button>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Card 4: Contatti -->
    <div class="grid-card contacts-card">
      <div class="card-header">
        <h2 class="card-title">ğŸ“ Contatti</h2>
      </div>

      <div class="contacts-content">
        <div class="contact-item">
          <span class="contact-icon">ğŸ“§</span>
          <div class="contact-info">
            <span class="contact-label">Email</span>
            <span class="contact-value">{{ m.email }}</span>
          </div>
        </div>

        <div class="contact-item">
          <span class="contact-icon">ğŸ“±</span>
          <div class="contact-info">
            <span class="contact-label">Telefono</span>
            <span class="contact-value">{{ m.phone || 'Non specificato' }}</span>
          </div>
        </div>

        <div class="contact-item">
          <span class="contact-icon">ğŸ‚</span>
          <div class="contact-info">
            <span class="contact-label">Data di Nascita</span>
            <span class="contact-value">{{ athleteData.birthDate | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>

        <div class="contact-item">
          <span class="contact-icon">â³</span>
          <div class="contact-info">
            <span class="contact-label">EtÃ </span>
            <span class="contact-value">{{ getAge(athleteData.birthDate) }} anni</span>
          </div>
        </div>

        <div class="contact-item">
          <span class="contact-icon">{{ athleteData.gender === 'M' ? 'â™‚ï¸' : 'â™€ï¸' }}</span>
          <div class="contact-info">
            <span class="contact-label">Sesso</span>
            <span class="contact-value">{{ athleteData.gender === 'M' ? 'Maschio' : 'Femmina' }}</span>
          </div>
        </div>

        <button class="card-action-btn secondary" (click)="notImplementedYet('Invio messaggi')">ğŸ’¬ Invia
          Messaggio</button>
      </div>
    </div>
  </div>

  <!-- Sezione Analytics (sotto tutto) -->
  <div class="analytics-section">
    <h2 class="section-title">ğŸ“Š Statistiche Presenze</h2>

    <div class="analytics-grid">
      <!-- Frequenza Mensile -->
      <div class="analytics-card">
        <h3 class="analytics-title">Frequenza Mensile</h3>
        <div class="chart-container">
          @for (month of monthlyAttendance; track month.month) {
          <div class="bar-item">
            <div class="bar-wrapper">
              <div class="bar-fill" [style.height.%]="(month.count / maxAttendance) * 100"></div>
            </div>
            <span class="bar-label">{{ month.month }}</span>
            <span class="bar-value">{{ month.count }}</span>
          </div>
          }
        </div>
      </div>

      <!-- Distribuzione Settimanale -->
      <div class="analytics-card">
        <h3 class="analytics-title">Distribuzione Settimanale</h3>
        <div class="chart-container">
          @for (day of weeklyDistribution; track day.day) {
          <div class="bar-item">
            <div class="bar-wrapper">
              <div class="bar-fill" [style.height.%]="day.count > 0 ? (day.count / maxWeekly) * 100 : 0"></div>
            </div>
            <span class="bar-label">{{ day.day }}</span>
            <span class="bar-value">{{ day.count }}</span>
          </div>
          }
        </div>
      </div>

      <!-- Obiettivo Mensile -->
      <div class="analytics-card goal-card">
        <h3 class="analytics-title">Obiettivo Mensile</h3>
        <div class="goal-content">
          <svg class="progress-ring" width="120" height="120">
            <circle class="progress-ring-circle-bg" stroke="#e5e7eb" stroke-width="8" fill="transparent" r="50" cx="60"
              cy="60" />
            <circle class="progress-ring-circle" stroke="#3066BE" stroke-width="8" fill="transparent" r="50" cx="60"
              cy="60" [style.stroke-dasharray]="2 * 3.14159 * 50" [style.stroke-dashoffset]="progressOffset" />
            <text x="60" y="60" class="progress-text" text-anchor="middle" dy=".3em">
              {{ attendancePercentage }}%
            </text>
          </svg>
          <div class="goal-details">
            <p class="goal-status">{{ currentAttendance }} / {{ goalAttendance }} presenze</p>
          </div>
        </div>
      </div>

      <!-- Serie Attuale -->
      <div class="analytics-card streak-card">
        <h3 class="analytics-title">Serie Attuale</h3>
        <div class="streak-content">
          <div class="streak-number">ğŸ”¥ {{ currentStreak }}</div>
          <div class="streak-label">giorni consecutivi</div>
          <div class="streak-record">Record personale: {{ bestStreak }} giorni</div>
        </div>
      </div>
    </div>
  </div>
  }
</div>